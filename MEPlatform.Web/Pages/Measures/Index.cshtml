@page
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@model MEPlatform.Web.Pages.Measures.IndexModel
@{
    ViewData["Title"] = "Measures Management";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-graph-up-arrow me-2"></i>Measures Management
            </h1>
            <p class="text-muted mb-0">Track and manage measurement indicators across all projects</p>
        </div>
        <div>
            @if (User.IsInRole("SuperAdministrator") || User.IsInRole("Supervisor") || User.IsInRole("ProgramManager"))
            {
                <a href="@Url.Page("./Create")" class="btn btn-primary">
                    <i class="bi bi-plus-lg me-1"></i>Add New Measure
                </a>
            }
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@Model.Statistics.TotalMeasures</h4>
                            <p class="mb-0">Total Measures</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-graph-up fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@Model.Statistics.ActiveMeasures</h4>
                            <p class="mb-0">Active Measures</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-activity fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@Model.Statistics.AverageAchievement.ToString("F1")%</h4>
                            <p class="mb-0">Avg Achievement</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-target fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">@Model.Statistics.VerifiedMeasures</h4>
                            <p class="mb-0">Verified Measures</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-check-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Overview -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Performance Metrics</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 class="text-primary mb-0">@Model.Statistics.AverageFinancialPerformance.ToString("F1")%</h4>
                            <small class="text-muted">Financial Performance</small>
                        </div>
                        <div class="col-6">
                            <h4 class="text-success mb-0">@Model.Statistics.AveragePhysicalPerformance.ToString("F1")%</h4>
                            <small class="text-muted">Physical Performance</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Quality Overview</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <h5 class="text-success mb-0">@Model.Statistics.HighPerformingMeasures</h5>
                            <small class="text-muted">High Performing</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-danger mb-0">@Model.Statistics.LowPerformingMeasures</h5>
                            <small class="text-muted">Low Performing</small>
                        </div>
                        <div class="col-4">
                            <h5 class="text-warning mb-0">@Model.Statistics.OverdueMeasures</h5>
                            <small class="text-muted">Overdue</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" name="searchTerm" value="@Model.SearchTerm" 
                           placeholder="Search measures, projects, indicators...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Project</label>
                    <select class="form-select" name="projectFilter">
                        <option value="">All Projects</option>
                        @foreach (var project in Model.Projects)
                        {
                            <option value="@project" selected="@(Model.ProjectFilter == project)">@project</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Type</label>
                    <select class="form-select" name="typeFilter">
                        <option value="">All Types</option>
                        @foreach (var type in Model.MeasureTypes)
                        {
                            <option value="@type" selected="@(Model.TypeFilter == type)">@type</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Frequency</label>
                    <select class="form-select" name="frequencyFilter">
                        <option value="">All Frequencies</option>
                        @foreach (var frequency in Model.Frequencies)
                        {
                            <option value="@frequency" selected="@(Model.FrequencyFilter == frequency)">@frequency</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="statusFilter">
                        <option value="">All Status</option>
                        <option value="Active" selected="@(Model.StatusFilter == "Active")">Active</option>
                        <option value="Completed" selected="@(Model.StatusFilter == "Completed")">Completed</option>
                        <option value="On Hold" selected="@(Model.StatusFilter == "On Hold")">On Hold</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-outline-primary">Filter</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Measures Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Measures (@Model.Measures.Count)</h5>
        </div>
        <div class="card-body">
            @if (Model.Measures.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover" id="measuresTable">
                        <thead class="table-light">
                            <tr>
                                <th>Measure</th>
                                <th>Project</th>
                                <th>Indicator</th>
                                <th>Type</th>
                                <th>Progress</th>
                                <th>Performance</th>
                                <th>Status</th>
                                <th>Verification</th>
                                <th>Last Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var measure in Model.Measures)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-bold">@measure.Name</div>
                                        <small class="text-muted">@measure.Unit - @measure.Frequency</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-outline-primary">@measure.ProjectName</span>
                                    </td>
                                    <td>@measure.IndicatorName</td>
                                    <td>
                                        <span class="badge @(measure.MeasureType switch 
                                        {
                                            "Quantitative" => "bg-info",
                                            "Qualitative" => "bg-warning",
                                            "Binary" => "bg-secondary",
                                            _ => "bg-light text-dark"
                                        })">@measure.MeasureType</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="me-2 fw-bold">@measure.Achievement.ToString("F1")%</span>
                                            <div class="progress flex-fill" style="height: 4px; width: 60px;">
                                                <div class="progress-bar @(measure.Achievement >= 80 ? "bg-success" : measure.Achievement >= 60 ? "bg-warning" : "bg-danger")" 
                                                     style="width: @measure.Achievement%"></div>
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            @(measure.CurrentValue?.ToString("N1") ?? "N/A") / @(measure.Target?.ToString("N1") ?? "N/A")
                                        </small>
                                    </td>
                                    <td>
                                        <div class="text-center">
                                            <small class="text-primary d-block">F: @measure.FinancialPerformance.ToString("F1")%</small>
                                            <small class="text-success d-block">P: @measure.PhysicalPerformance.ToString("F1")%</small>
                                            <small class="@(measure.Trend >= 0 ? "text-success" : "text-danger")">
                                                @(measure.Trend >= 0 ? "+" : "")@measure.Trend.ToString("F1")%
                                            </small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge @(measure.Status switch 
                                        {
                                            "Active" => "bg-success",
                                            "Completed" => "bg-primary",
                                            "On Hold" => "bg-warning text-dark",
                                            _ => "bg-secondary"
                                        })">@measure.Status</span>
                                    </td>
                                    <td class="text-center">
                                        @if (measure.IsVerified)
                                        {
                                            <i class="bi bi-check-circle-fill text-success" title="Verified"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-exclamation-circle-fill text-warning" title="Pending Verification"></i>
                                        }
                                        <div class="small text-muted">@measure.DataQuality</div>
                                    </td>
                                    <td class="small">
                                        @if (measure.LastUpdated.HasValue)
                                        {
                                            @measure.LastUpdated.Value.ToString("MMM dd, yyyy")
                                        }
                                        else
                                        {
                                            <span class="text-muted">Never</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="@Url.Page("./Details", new { id = measure.Id })" 
                                               class="btn btn-outline-primary btn-sm" title="View Details">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            @if (User.IsInRole("SuperAdministrator") || User.IsInRole("Supervisor") || User.IsInRole("ProgramManager"))
                                            {
                                                <a href="@Url.Page("./Edit", new { id = measure.Id })" 
                                                   class="btn btn-outline-secondary btn-sm" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                            @if (User.IsInRole("SuperAdministrator") || User.IsInRole("Supervisor"))
                                            {
                                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                                        data-bs-toggle="modal" data-bs-target="#deleteModal" 
                                                        data-measure-id="@measure.Id" 
                                                        data-measure-name="@measure.Name"
                                                        title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-4">
                    <i class="bi bi-graph-up fs-1 text-muted"></i>
                    <h5 class="text-muted mt-3">No measures found</h5>
                    <p class="text-muted">No measures match your current filters.</p>
                    @if (User.IsInRole("SuperAdministrator") || User.IsInRole("Supervisor") || User.IsInRole("ProgramManager"))
                    {
                        <a href="@Url.Page("./Create")" class="btn btn-primary">
                            <i class="bi bi-plus-lg me-1"></i>Add First Measure
                        </a>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this measure?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will permanently delete the measure "<span id="measureName"></span>" and all its historical data. This cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <form method="post" style="display: inline;">
                    <input type="hidden" name="handler" value="Delete" />
                    <input type="hidden" name="id" id="measureIdToDelete" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Measure
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize DataTables
            $('#measuresTable').DataTable({
                "pageLength": 25,
                "order": [[8, "desc"]], // Sort by last updated
                "columnDefs": [
                    { "orderable": false, "targets": [9] } // Disable sorting on Actions column
                ]
            });

            // Handle delete modal
            $('#deleteModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var measureId = button.data('measure-id');
                var measureName = button.data('measure-name');
                
                $('#measureIdToDelete').val(measureId);
                $('#measureName').text(measureName);
            });

            // Handle success/error messages
            @if (TempData["SuccessMessage"] != null)
            {
                <text>
                toastr.success('@Html.Raw(TempData["SuccessMessage"])');
                </text>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <text>
                toastr.error('@Html.Raw(TempData["ErrorMessage"])');
                </text>
            }
        });
    </script>
}