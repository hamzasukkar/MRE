@page "{id:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "SuperAdministrator,Supervisor,ProgramManager")]
@model MEPlatform.Web.Pages.Measures.EditModel
@{
    ViewData["Title"] = $"Edit Measure - {Model.Measure?.Name}";
}

<div class="container-fluid">
    <!-- Header with Breadcrumb -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="@Url.Page("/Measures/Index")">Measures</a></li>
                <li class="breadcrumb-item active">Edit Measure</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1 class="h3 mb-0">
                    <i class="bi bi-pencil-square me-2"></i>Edit Measure
                </h1>
                <p class="text-muted mb-0">Update measurement indicator details and performance data</p>
            </div>
            @if (User.IsInRole("SuperAdministrator") || User.IsInRole("Supervisor"))
            {
                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash me-1"></i>Delete Measure
                </button>
            }
        </div>
    </div>

    <!-- Edit Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-form me-2"></i>Measure Information</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        <input type="hidden" asp-for="Measure!.Id" />
                        <input type="hidden" asp-for="Measure!.CreatedAt" />

                        @if (!ViewData.ModelState.IsValid)
                        {
                            <div class="alert alert-danger">
                                <h6><i class="bi bi-exclamation-triangle me-2"></i>Please correct the following errors:</h6>
                                <ul class="mb-0">
                                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                                    {
                                        <li>@error.ErrorMessage</li>
                                    }
                                </ul>
                            </div>
                        }

                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Name" class="form-label">Measure Name <span class="text-danger">*</span></label>
                                    <input asp-for="Measure!.Name" class="form-control">
                                    <span asp-validation-for="Measure!.Name" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Unit" class="form-label">Unit <span class="text-danger">*</span></label>
                                    <input asp-for="Measure!.Unit" class="form-control">
                                    <span asp-validation-for="Measure!.Unit" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Measure!.Description" class="form-label">Description <span class="text-danger">*</span></label>
                            <textarea asp-for="Measure!.Description" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Measure!.Description" class="text-danger"></span>
                        </div>

                        <!-- Project and Indicator Assignment -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Measure!.ProjectId" class="form-label">Project <span class="text-danger">*</span></label>
                                    <select asp-for="Measure!.ProjectId" class="form-select">
                                        <option value="">Select a project</option>
                                        @foreach (var project in Model.Projects)
                                        {
                                            <option value="@project.Id" selected="@(Model.Measure.ProjectId == project.Id)">@project.Name (@project.Region - @project.Sector)</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Measure!.ProjectId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Measure!.IndicatorId" class="form-label">Indicator <span class="text-danger">*</span></label>
                                    <select asp-for="Measure!.IndicatorId" class="form-select">
                                        <option value="">Select an indicator</option>
                                        @foreach (var indicator in Model.Indicators)
                                        {
                                            <option value="@indicator.Id" selected="@(Model.Measure.IndicatorId == indicator.Id)">@indicator.Name (@indicator.Unit)</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Measure!.IndicatorId" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Measure Configuration -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.MeasureType" class="form-label">Type <span class="text-danger">*</span></label>
                                    <select asp-for="Measure!.MeasureType" class="form-select">
                                        @foreach (var type in Model.MeasureTypes)
                                        {
                                            <option value="@type" selected="@(Model.Measure.MeasureType == type)">@type</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Measure!.MeasureType" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Frequency" class="form-label">Frequency <span class="text-danger">*</span></label>
                                    <select asp-for="Measure!.Frequency" class="form-select">
                                        @foreach (var frequency in Model.Frequencies)
                                        {
                                            <option value="@frequency" selected="@(Model.Measure.Frequency == frequency)">@frequency</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Measure!.Frequency" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Status" class="form-label">Status <span class="text-danger">*</span></label>
                                    <select asp-for="Measure!.Status" class="form-select">
                                        @foreach (var status in Model.Statuses)
                                        {
                                            <option value="@status" selected="@(Model.Measure.Status == status)">@status</option>
                                        }
                                    </select>
                                    <span asp-validation-for="Measure!.Status" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.DataQuality" class="form-label">Data Quality</label>
                                    <select asp-for="Measure!.DataQuality" class="form-select">
                                        @foreach (var quality in Model.DataQualityLevels)
                                        {
                                            <option value="@quality" selected="@(Model.Measure.DataQuality == quality)">@quality</option>
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Data Collection Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Measure!.DataSource" class="form-label">Data Source <span class="text-danger">*</span></label>
                                    <input asp-for="Measure!.DataSource" class="form-control">
                                    <span asp-validation-for="Measure!.DataSource" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Measure!.CollectionMethod" class="form-label">Collection Method <span class="text-danger">*</span></label>
                                    <input asp-for="Measure!.CollectionMethod" class="form-control">
                                    <span asp-validation-for="Measure!.CollectionMethod" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Values and Performance -->
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Target" class="form-label">Target Value</label>
                                    <input asp-for="Measure!.Target" class="form-control" type="number" step="0.01">
                                    <span asp-validation-for="Measure!.Target" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.CurrentValue" class="form-label">Current Value</label>
                                    <input asp-for="Measure!.CurrentValue" class="form-control" type="number" step="0.01">
                                    <span asp-validation-for="Measure!.CurrentValue" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.BaselineValue" class="form-label">Baseline Value</label>
                                    <input asp-for="Measure!.BaselineValue" class="form-control" type="number" step="0.01">
                                    <span asp-validation-for="Measure!.BaselineValue" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Achievement" class="form-label">Achievement %</label>
                                    <input asp-for="Measure!.Achievement" class="form-control" type="number" step="0.01" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Metrics -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Measure!.FinancialPerformance" class="form-label">Financial Performance %</label>
                                    <input asp-for="Measure!.FinancialPerformance" class="form-control" type="number" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Measure!.PhysicalPerformance" class="form-label">Physical Performance %</label>
                                    <input asp-for="Measure!.PhysicalPerformance" class="form-control" type="number" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="Measure!.Trend" class="form-label">Trend %</label>
                                    <input asp-for="Measure!.Trend" class="form-control" type="number" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="Measure!.ResponsiblePerson" class="form-label">Responsible Person</label>
                                    <input asp-for="Measure!.ResponsiblePerson" class="form-control">
                                    <span asp-validation-for="Measure!.ResponsiblePerson" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Data Verification</label>
                                    <div class="form-check">
                                        <input asp-for="Measure!.IsVerified" class="form-check-input" type="checkbox">
                                        <label asp-for="Measure!.IsVerified" class="form-check-label">
                                            Mark as verified
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="@Url.Page("./Index")" class="btn btn-outline-secondary">
                                <i class="bi bi-arrow-left me-1"></i>Back to Measures
                            </a>
                            <div>
                                <a href="@Url.Page("./Details", new { id = Model.Measure!.Id })" class="btn btn-outline-info me-2">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-lg me-1"></i>Update Measure
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Summary Panel -->
        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Measure Summary</h6>
                </div>
                <div class="card-body">
                    <dl class="row small">
                        <dt class="col-sm-5">Created:</dt>
                        <dd class="col-sm-7">@Model.Measure?.CreatedAt.ToString("MMM dd, yyyy")</dd>
                        
                        <dt class="col-sm-5">Last Updated:</dt>
                        <dd class="col-sm-7">
                            @if (Model.Measure?.LastUpdated.HasValue == true)
                            {
                                @Model.Measure.LastUpdated.Value.ToString("MMM dd, yyyy")
                            }
                            else
                            {
                                <span class="text-muted">Never</span>
                            }
                        </dd>
                        
                        <dt class="col-sm-5">Current Status:</dt>
                        <dd class="col-sm-7">
                            <span class="badge @(Model.Measure?.Status switch 
                            {
                                "Active" => "bg-success",
                                "Planning" => "bg-info",
                                "On Hold" => "bg-warning text-dark",
                                "Completed" => "bg-primary",
                                "Cancelled" => "bg-danger",
                                _ => "bg-secondary"
                            })">@Model.Measure?.Status</span>
                        </dd>
                        
                        <dt class="col-sm-5">Verification:</dt>
                        <dd class="col-sm-7">
                            @if (Model.Measure?.IsVerified == true)
                            {
                                <i class="bi bi-check-circle-fill text-success me-1"></i><span class="text-success">Verified</span>
                            }
                            else
                            {
                                <i class="bi bi-exclamation-circle-fill text-warning me-1"></i><span class="text-warning">Pending</span>
                            }
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Performance Overview -->
            <div class="card bg-light mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-graph-up me-2"></i>Performance Overview</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h5 class="text-primary mb-0">@Model.Measure?.FinancialPerformance.ToString("F1")%</h5>
                            <small class="text-muted">Financial</small>
                        </div>
                        <div class="col-6">
                            <h5 class="text-success mb-0">@Model.Measure?.PhysicalPerformance.ToString("F1")%</h5>
                            <small class="text-muted">Physical</small>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <h4 class="@((Model.Measure?.Trend ?? 0) >= 0 ? "text-success" : "text-danger") mb-0">
                            @((Model.Measure?.Trend ?? 0) >= 0 ? "+" : "")@Model.Measure?.Trend.ToString("F1")%
                        </h4>
                        <small class="text-muted">Trend</small>
                    </div>

                    @if (Model.Measure?.Target.HasValue == true && Model.Measure?.CurrentValue.HasValue == true)
                    {
                        var progress = Math.Min((Model.Measure.CurrentValue.Value / Model.Measure.Target.Value) * 100, 100);
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-1">
                                <small>Progress to Target</small>
                                <small>@progress.ToString("F1")%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar @(progress >= 90 ? "bg-success" : progress >= 70 ? "bg-warning" : "bg-danger")" 
                                     style="width: @progress%"></div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this measure?</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action will permanently delete the measure "@Model.Measure?.Name" and all its historical data. This cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <form method="post" style="display: inline;">
                    <input type="hidden" name="handler" value="Delete" />
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Measure
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-calculate achievement percentage
            function calculateAchievement() {
                var current = parseFloat($('#Measure_CurrentValue').val()) || 0;
                var target = parseFloat($('#Measure_Target').val()) || 0;
                
                if (target > 0) {
                    var achievement = (current / target) * 100;
                    $('#Measure_Achievement').val(achievement.toFixed(1));
                } else {
                    $('#Measure_Achievement').val('0');
                }
            }

            // Calculate achievement when values change
            $('#Measure_CurrentValue, #Measure_Target').on('input', calculateAchievement);

            // Form validation and UX improvements
            $('form').on('submit', function() {
                $(this).find('button[type="submit"]').prop('disabled', true).html('<i class="spinner-border spinner-border-sm me-1"></i>Updating...');
            });

            // Initialize achievement calculation
            calculateAchievement();
        });
    </script>
}